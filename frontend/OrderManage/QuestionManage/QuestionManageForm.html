<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>问题添加</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta http-equiv="X-UA-Compatible" content="ie=edge">
		<link rel="stylesheet" href="../../Lib/bootstrap-3.3.7-dist/css/bootstrap.min.css">
		<link rel="stylesheet" href="../../Lib/layer/theme/default/layer.css">
		<link rel="stylesheet" href="../../Lib/select/css/select-mania.css" />
		<link rel="stylesheet" href="../../Lib/bootstrap-datapicker/bootstrap-datetimepicker.min.css" />
		<link rel="stylesheet" href="../../Lib/select/css/select-mania.css" />
		<link rel="stylesheet" href="../../Lib/jsTree/style.min.css">
		<link rel="stylesheet" href="../../Lib/easyUpload/main.css">
		<link rel="stylesheet" href="../../Static/Css/changeManage.css">
		<style>
			html,
			body {
				height: 100%;
				width: 100%;
				overflow: auto;
			}
			
			.urgent {
				display: inline-block;
				width: 23%;
				cursor: pointer;
			}
			
			.urgent .label:empty {
				display: inline-block;
				width: 65px;
				height: 15px;
				position: absolute;
				background: #E4E4E4;
				margin-top: 5px;
			}
			
			.urgent span:first-child {
				font-size: 12px;
				margin-left: 18px;
				margin-top: 8px;
			}
			
			.col-form-label {
				text-align: right;
			}
			
			.form-group {
				margin-left: 0!important;
				margin-right: 0!important;
			}
			
			.btn {
				background: #13a2ff;
				border: 1px solid #0187dd;
			}
			
			.sf-mf {
				padding: 15px;
				border: 1px solid #dadbdf;
				height: 87%;
				overflow: auto;
			}
			
			.fs_main {
				padding: 0 15px;
				height: 100%;
			}
			
			.easy-uploader .btn {
				color: #ffffff;
			}
			thead{
				background-color: #e8e6e6;
			}
			a{
				cursor: pointer;
			}
		</style>
	</head>

	<body>
		<div class="fs_main">
			<div style="width: 100%;">
				<div class="floatParent" style="padding:15px">
					<div class="pageTitle">新增问题</div>
					<button style="margin-right: 15px;float: right;" class="btn btn-primary" onclick="javascript :history.back(-1)">返回</button>
				</div>
			</div>
			<div class="sf-mf">
				<div class="form-title floatParent">
					<div class="title-info">基本信息</div>
				</div>
				<form class="form-horizontal" id="changeForm">
					<div class="form-group ">
						<label for="ORDER_NAME" class="control-label col-sm-2 "><span class="required">问题名称</span></label>
						<div class="col-sm-5">
							<input type="text" class="form-control" id="ORDER_NAME" name="ORDER_NAME" placeholder="请输入问题名称" />
						</div>
					</div>
					<div class="form-group">
						<label for="ORDER_DSC" class="control-label col-sm-2"><span class="required">问题描述</span></label>
						<div class="col-sm-5">
							<textarea rows="5" maxlength="250" placeholder="只能输入250个字" id="ORDER_DSC" name="ORDER_DSC" class="form-control"></textarea>
						</div>
					</div>
					<div class="form-group">
						<label for="SYSTEM_NAME" class="control-label col-sm-2"><span class="required">来源系统</span></label>
						<div class="col-sm-2" id="SystemSelect">
							<input id="SYSTEM_TEXT" type="text" readonly class="form-control search-input" placeholder="请选择">
							<input id="SYSTEM_NAME" name="SYSTEM_NAME" type="hidden">
							<div id="SystemTreeId" style="position:absolute;border:1px solid #3BA4FF;border-radius: 3px;border-top:0px;-moz-border-radius-topleft:0px ;-moz-border-radius-topright: 0px;overflow: auto;display: none;background: #fff;z-index:9999;max-height: 230px;width: 91%;font-size: 10px;"></div>
						</div>
						<label for="ORDER_CLASS" class="col-sm-1 control-label"><span class="required">问题类型</span></label>
						<div class="col-sm-2">
							<select id="ORDER_CLASS" name="ORDER_CLASS" class="form-control">
							</select>
						</div>
						
					</div>

					<div class="form-group">
						<label for="ORDER_SOURCE" class="col-sm-2 control-label"><span class="required">问题来源</span></label>
						<div class="col-sm-2">
							<select id="ORDER_SOURCE" data-placeholder="请选择问题来源" name="ORDER_SOURCE" class="form-control">
							</select>
						</div>
						<label for="FK_DEPART" class="control-label col-sm-1"><span class="required">反馈部门</span></label>
						<div class="col-sm-2" id="departSelect">
							<input id="DEPAET_NAME" type="text" readonly class="form-control search-input" placeholder="请选择">
							<input id="FK_DEPART" name="FK_DEPART" type="hidden">
							<div id="departTreeId" style="position:absolute;border:1px solid #3BA4FF;border-radius: 3px;border-top:0px;-moz-border-radius-topleft:0px ;-moz-border-radius-topright: 0px;overflow: auto;display: none;background: #fff;z-index:9999;max-height: 230px;width: 91%;font-size: 10px;"></div>
						</div>
					</div>
					<div class="form-group">
						<label for="CONNECT_USER" class="control-label col-sm-2"><span class="required">联系人</span></label>
						<div class="col-sm-2">
							<input type="text" id="CONNECT_USER" name="CONNECT_USER" class="form-control" placeholder="请输入联系人">
						</div>
						<label for="CONNECT_TEL" class="control-label col-sm-1"><span class="required">联系电话</span></label>
						<div class="col-sm-2">
							<input type="text" maxlength="11" name="CONNECT_TEL" id="CONNECT_TEL" class="form-control" placeholder="请输入联系电话">
						</div>

					</div>
					<div class="form-group ">
						<label class="col-sm-2 control-label"><span class="required">紧急程度</span></label>
						<div class="col-sm-2">
							<div>
								<div id="di" onclick="urgent(4,this)" class="urgent EM_LEVEL"><span>&nbsp;&nbsp;低 </span><br><span class="label label-badge"></span></div>
								<div onclick="urgent(3,this)" class="urgent EM_LEVEL"><span>&nbsp;&nbsp;中</span><br><span class="label label-badge"></span></div>
								<div onclick="urgent(2,this)" class="urgent EM_LEVEL"><span>&nbsp;&nbsp;高</span><br><span class="label label-badge"></span></div>
								<div onclick="urgent(1,this)" class="urgent EM_LEVEL"><span>紧急</span><br><span class="label label-badge"></span></div>
								<input value="4" type="hidden" id="EMER_LEVEL" name="EMER_LEVEL" class="urgent_input">
							</div>
						</div>
						<label class="col-sm-1 control-label"><span class="required">期望完成时间</span></label>
						<div class="col-sm-2">
							<div class="input-group date form_date" id="EXPET_TIME" data-date="" data-date-format="yyyy-mm-dd" data-link-field="dtp_input2" data-link-format="yyyy-mm-dd">
								<input class="form-control" size="16" type="text" id="TIME" value="" readonly>
								<span class="input-group-addon"><span class="glyphicon glyphicon-remove"></span></span>
								<span class="input-group-addon"><span class="glyphicon glyphicon-calendar"></span></span>
							</div>
						</div>
						<label style="display: none;" for="P_SYS_USER_ID" class="col-sm-1 control-label"><span class="required">其它系统工号</span></label>
						<div style="display: none;" class="col-sm-2">
							<input class="form-control" name="P_SYS_USER_ID" id="P_SYS_USER_ID">
						</div>
					</div>
					<div class="form-group">
						<label class="col-sm-2 control-label">附件</label>
						<div class="col-sm-5">
							<div id="uploader">
								<div class="easy-uploader">
									<div class="btn-box"><span class="btn-select-file btn">选取文件</span><i style="display: none !important;" class="btn-check-all cursor-select checkbox unchecked"></i><input class="input-file" type="file" accept=".*" multiple="multiple" style="display:none;"></div>
									<ul class="list"></ul>
								</div>
							</div>
						</div>
					</div>
				</form>
				<div class="form-title floatParent">
					<div class="title-info">关联工单</div>
					<div style="float: right">
						<button type="button" onclick="connectOrder()">添加关联工单</button>
					</div>
				</div>
				<div style="padding: 10px 25px">
					<table class="table table-bordered">
						<thead>
						<tr><td>ID</td><td>标题</td><td style="width: 40%">内容</td><td>工单类型</td><td>创建时间</td><td>创建人</td><td>操作</td></tr>
						</thead>
						<tbody id="connectBody">
						<tr id="noneInfo"><td colspan="7" style="text-align: center">暂无关联信息</td></tr>
						</tbody>
					</table>
				</div>

				<div style="width: 100%;height: 30px;text-align: center;">
					<button class="pageButton btn btn-primary" type="button" onclick="Save()">暂存</button>
					<button class="pageButton btn btn-primary" type="button" onclick="SubForm()">提交</button>
					<button style="margin-left: 15px;" class="pageButton btn btn-primary" type="button" onclick="paperBack()">返回</button>
				</div>
			</div>
		</div>
		<script src="../../Lib/jquery-3.4.1.min.js"></script>
		<script src="../../Lib/bootstrap-3.3.7-dist/js/bootstrap.js"></script>
		<script src="../../Lib/bootstrap-datapicker/bootstrap-datetimepicker.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../Lib/bootstrap-datapicker/bootstrap-datetimepicker.zh-CN.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../Lib/layer/layer.js"></script>
		<script src="../../Lib/select/js/select-mania.js"></script>
		<script src="../../Lib/easyUpload/easyUploader.js"></script>
		<script src="../../Lib/all.js" type="text/javascript"></script>
		<script src="../../Lib/public.js"></script>
		<script src="../../Lib/jsTree/jstree.js"></script>
		<script type="text/javascript">
			var fileid = "";
			var fas;
			var EVENT_ID=$.url("EVENT_ID");
			$(function() {
				$('#EXPET_TIME').datetimepicker({
					language: 'zh-CN',
					weekStart: 1,
					todayBtn: 1,
					autoclose: 1,
					todayHighlight: 1,
					startView: 2,
					minView: 2,
					forceParse: 0
				});

				$('#ORDER_SOURCE').selectMania({
					themes: ['green'],
					placeholder: '请选择问题来源',
					removable: true,
					ajax: false,
				});
				$('#ORDER_CLASS').selectMania({
					themes: ['green'],
					placeholder: '请选择问题类型',
					removable: true,
					ajax: false,
				});
				urgent(4, $("#di"));
				getSelectjquery({
					"P_EVENT_ID":EVENT_ID,
				}, 'ORDER_CLASS', '/order/OrderTypeCombo');
				getSelectjquery({
					"P_TABLE": "TR_BASE_APPLY_XX",
					"P_COLUMN": "SOURCE"
				}, 'ORDER_SOURCE', '/ProcessHandler/GetProcessType');

				$("#CONNECT_TEL").blur(function() {
					checkTel();
				})
				getDepartTree();
				getSystemTree();
				$('.target-selector').selectMania('clear');
			});

			function getSelectjquery(data, useId, url) {
				webapi(url, data, function(res) {
					var str = "";
					if(res.length > 0) {
						$.each(res, function(i, item) {
							str += "<option  value=" + item.ID + ">" + item.TEXT + "</option>";
						});
						$("#" + useId).append(str);
						$('#' + useId).selectMania('update');
					}
				}, function(err) {
					layer.alert("获取下拉数据错误,错误信息为" + err);
				});

			}

			function urgent(num, obj) {
				$(".col-sm-8 span").css("color", "black");
				$('.urgent').css("color", "#353535");
				$('.urgent .label').css("background", "#E4E4E4");
				$("#NAME-" + num).css("color", "red");
				var color = "";
				switch(num) {
					case 4:
						color = "#11bae1";
						break;
					case 3:
						color = "orange";
						break;
					case 2:
						color = "#f4e60d";
						break;
					case 1:
						color = "red";
						break;
				}
				$(obj).children(".label").css("background", color);
				$("#EMER_LEVEL").val(num);
			}

			function SubForm() {
				if(validateForm()) {
					var connect_ids = getConnectIds();
					var value = {
						"P_EVENT_ID": 1000, //--表单流程事件ID
						"P_SYS_USER_ID": "", //指定工单处理人，没有传空值
						"P_OPER_ID": "1000", //操作工号
						"P_FUJIAN_STR": fileid, //处理时上传的附件，附件信息拼接字符
						"ORDER_NAME": $("#ORDER_NAME").val(),
						"ORDER_DSC": $("#ORDER_DSC").val(),
						"SYSTEM_NAME":$("#SYSTEM_TEXT").val(),
						"SYSTEM_ID": $("#SYSTEM_NAME").val(),
						"CONNECT_TEL": $("#CONNECT_TEL").val(),
						"CONNECT_USER": $("#CONNECT_USER").val(),
						"ORDER_SOURCE": $("#ORDER_SOURCE").selectMania('get')[0].text,
						"EXPET_TIME": $("#EXPET_TIME").find("input").val(),
						"ORDER_CLASS": $("#ORDER_CLASS").selectMania('get')[0].text,
						"FK_DEPART": $("#DEPAET_NAME").val(),
						"EMER_LEVEL": $("#EMER_LEVEL").val(),
						"P_RESEND_ID": "",
						"P_CONNECT_ID":connect_ids
					}
					orderAdd(value);
				}
			}

			function Save() {
				if(validateForm()) {
					var connect_ids = getConnectIds();
					var value = {
						"P_EVENT_ID": 1000, //--表单流程事件ID
						"P_SYS_USER_ID": "", //指定工单处理人，没有传空值
						"P_OPER_ID": "1001", //操作工号
						"P_FUJIAN_STR": fileid, //处理时上传的附件，附件信息拼接字符
						"ORDER_NAME": $("#ORDER_NAME").val(),
						"ORDER_DSC": $("#ORDER_DSC").val(),
						"SYSTEM_NAME":$("#SYSTEM_TEXT").val(),
						"SYSTEM_ID": $("#SYSTEM_NAME").val(),
						"CONNECT_TEL": $("#CONNECT_TEL").val(),
						"CONNECT_USER": $("#CONNECT_USER").val(),
						"ORDER_SOURCE": $("#ORDER_SOURCE").selectMania('get')[0].text,
						"EXPET_TIME": $("#EXPET_TIME").find("input").val(),
						"ORDER_CLASS": $("#ORDER_CLASS").selectMania('get')[0].text,
						"FK_DEPART": $("#DEPAET_NAME").val(),
						"EMER_LEVEL": $("#EMER_LEVEL").val(),
						"P_RESEND_ID": "",
						"P_CONNECT_ID":connect_ids
					}
					orderSave(value);
				}
			}
			//加载部门树
			function getSystemTree() {
				$departTree = $('#SystemTreeId').jstree({
					'core': {
						"multiple": false,
						'data': {
							"url": urlpath + "/order/GetProsysTree",
							"data": function(node) {
								return {
									"id": node.id
								};
							}
						}
					},
					"plugins": ["search"],
					"search": {
						"show_only_matches": true,
						"show_only_matches_children": true
					}
				});
				$departTree.bind('activate_node.jstree', function(obj, e) {
					$("#SYSTEM_NAME").val(e.node.id);
					$("#SYSTEM_TEXT").val(e.node.text);
				})
				$("#SystemSelect").on("blur", "#SYSTEM_TEXT", function(e) {
					setTimeout(function() {
						$("#SystemTreeId").hide();
					}, 200)
				})
				$("#SystemSelect").on("click", "#SYSTEM_TEXT", function() {
					if($("#SystemTreeId")[0].style.display == "none" ||
						$("#SystemTreeId")[0].style.display == "") {
						$("#SystemTreeId")[0].style.display = "block";
					} else if($("#SystemTreeId")[0].style.display == "block") {
						$("#SystemTreeId")[0].style.display = "none";
					}
				});
			}
			//加载部门树
			function getDepartTree() {
				$departTree = $('#departTreeId').jstree({
					'core': {
						"multiple": false,
						'data': {
							"url": urlpath + "/DepartmentHander/getNDepartTree",
							"data": function(node) {
								node.id=="#"? "0":node.id;
								return {
									"P_PROSYS_ID":node.id,
								};
							}
						}
					},
					"plugins": ["search"],
					"search": {
						"show_only_matches": true,
						"show_only_matches_children": true
					}
				});
				$departTree.bind('activate_node.jstree', function(obj, e) {
					DP_TEXT = e.node.text;
					DP_VALUE = e.node.id;
					$("#FK_DEPART").val(DP_VALUE);
					$("#DEPAET_NAME").val(DP_TEXT);
				})
				$("#departSelect").on("blur", "#DEPAET_NAME", function(e) {
					setTimeout(function() {
						$("#departTreeId").hide();
					}, 200)
				})
				$("#departSelect").on("click", "#DEPAET_NAME", function() {
					if($("#departTreeId")[0].style.display == "none" ||
						$("#departTreeId")[0].style.display == "") {
						$("#departTreeId")[0].style.display = "block";
					} else if($("#departTreeId")[0].style.display == "block") {
						$("#departTreeId")[0].style.display = "none";
					}
				});
			}
			/**
			 * 表单提交前验证字段信息
			 * @returns {boolean}
			 */
			function validateForm() {
				var flag = true;
				var isEmpty = /^[\s]*$/;
				if(isEmpty.test($("#ORDER_NAME").val())) {
					layer.open({
						content: '请填写问题名称'
					});
					flag = false;
					return flag;
				}
				if(isEmpty.test($("#ORDER_DSC").val())) {
					layer.open({
						content: '请填写问题描述'
					});
					flag = false;
					return flag;
				}
				if($("#SYSTEM_NAME").val() == '') {
					layer.open({
						content: '请选择来源系统'
					});
					flag = false;
					return flag;
				}
				if(isEmpty.test($("#CONNECT_USER").val())) {
					layer.open({
						content: '请填写联系人信息'
					});
					flag = false;
					return flag;
				}
				if($("#CONNECT_TEL").val() == "") {
					layer.open({
						content: '请填写联系人电话信息'
					});
					flag = false;
					return flag;
				}
				if(isEmpty.test($("#FK_DEPART").val())) {
					layer.open({
						content: '请选择反馈部门'
					});
					flag = false;
					return flag;
				}
				if(isEmpty.test($("#ORDER_SOURCE").val())) {
					layer.open({
						content: '请选择问题来源'
					});
					flag = false;
					return flag;
				}
				if(isEmpty.test($("#ORDER_CLASS").val())) {
					layer.open({
						content: '请选择问题类型'
					});
					flag = false;
					return flag;
				}

				if(isEmpty.test($("#PLAN_START_TIME").find("input").val())) {
					layer.open({
						content: '请选择期望完成时间'
					});
					flag = false;
					return flag;
				}
				return flag;
			}

			function checkTel() {
				var obj = document.getElementById("CONNECT_TEL");
				var value = obj.value;
				var regTel1 = /^(([0\+]\d{2,3}-)?(0\d{2,3})-)(\d{7,8})(-(\d{3,}))?$/.test(value); //带区号的固定电话
				var reg = /^1[3|4|5|7|8][0-9]{9}$/.test(value);
				if(value != "") {
					if(!regTel1 && !reg) {
						layer.alert("电话号码输入有误！");
						fas = false;
						return false;
					}
				}
				fas = true;
				return true;
			}
			var uploader = easyUploader({
				id: "uploader",
				/* 渲染容器id */
				accept: '.jpg,.png,.gif,.txt,.pdf,.docx,.doc,.xlsx,.xls,.zip,.ppt,.pptx',
				/* 上传类型 */
				action: urlpath + "/attach/uploadFile",
				/* 上传地址 */
				autoUpload: true,
				/* 是否开启自动上传 */
				crossDomain: true,
				/* 是否允许跨域 */
				data: null,
				/* 上传配置参数，依据dataFormat而不同， */
				dataFormat: 'formData',

				/* 上传表单类型，有formData和base64两种 */
				dataType: 'json',
				/* 同$.ajax，�默认返回数据格式为json */
				headers: {
					// testKey: 'testValue'
				},
				/* 上传的请求头部，视需要配置 */
				maxCount: 5,
				/* 最大上传文件数 */
				maxSize: 3,
				/* 最大上传文件体积，单位M */
				multiple: true,
				/* 是否开启多选上传 */
				name: 'upfile',
				/* 上传的文件字段名 */
				previewWidth: 70,
				/* 压缩预览图的宽度，样式中高度等于宽度 */
				processData: false,
				/* 同$.ajax参数，这里默认为false */
				successKey: 'code',
				/* 标识上传成功的key */
				successValue: 200,
				/* 标识上传成功对应的value */
				showAlert: true,
				/* 是否开启alert提示 */
				timeout: 0,
				/* ajax请求超时时间，默认值为0，表示永不超时*/
				withCredentials: true,
				/* 是否支持发送 cookie 凭证信息 */
				beforeUpload: null,
				/* ajax上传前的回调函数 */
				onAlert: null, //alert时的钩子
				onChange: null, // input选中时触发
				onError: function(err) { //上传失败时的钩子
					layer.msg("文件上传失败");
				},
				onRemove: function(removedFiles, files) {
					/*
					 *批量删除时只返回removedFiles:剩下的文件信息,files为空
					 *单个删除时返回removedFiles，files,removedFiles:剩下的文件信息,files:删除的文件信息
					 */
					//console.log(removedFiles);
					fileid = "";
					for(var i = 0; i < removedFiles.length; i++) {
						if(fileid.indexOf(removedFiles[i].ajaxResponse.original) == -1) {
							fileid += removedFiles[i].ajaxResponse.original + '|' + removedFiles[i].ajaxResponse.url + ',';
						}
					};
				}, //移除文件时的钩子
				onSuccess: function(res) { //上传成功时的钩子
					if(res.state == "SUCCESS") {
						if(fileid.indexOf(res.original) == -1) {
							fileid += res.original + "|" + res.url + ",";
						}
					} else {
						layer.msg('系统暂只支持上传.jpg,.png,.gif,.txt,.pdf,.docx,.doc,.xlsx,.xls,.zip,.ppt,.pptx格式的文件!');
					}
				}
			});
		</script>

	</body>

</html>