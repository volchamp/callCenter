<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>发布申请</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta http-equiv="X-UA-Compatible" content="ie=edge">
		<link rel="stylesheet" href="../../Lib/bootstrap-3.3.7-dist/css/bootstrap.min.css">
		<link rel="stylesheet" href="../../Lib/layer/theme/default/layer.css">
		<link rel="stylesheet" href="../../Lib/select/css/select-mania.css" />
		<link rel="stylesheet" href="../../Lib/bootstrap-datapicker/bootstrap-datetimepicker.min.css" />
		<link rel="stylesheet" href="../../Lib/select/css/select-mania.css" />
		<link rel="stylesheet" href="../../Lib/jsTree/style.min.css">
		<link rel="stylesheet" href="../../Lib/easyUpload/main.css">
		<link rel="stylesheet" href="../../Static/Css/changeManage.css">
		<style>
			html,
			body {
				height: 100%;
				width: 100%;
				overflow: auto;
			}
			
			.fs_main {
				padding: 0 15px;
				height: 100%;
				overflow: hidden;
			}
			
			.sf-mf {
				padding: 15px;
				border: 1px solid #dadbdf;
				height: 87%;
				overflow: auto;
			}
			
			.col-form-label {
				text-align: right;
			}
			
			.form-group {
				margin-left: 0!important;
				margin-right: 0!important;
			}
			
			.btn {
				background: #13a2ff;
				border: 1px solid #0187dd;
			}
			
			.easy-uploader .btn {
				color: #ffffff;
			}
			thead{
				background-color: #e8e6e6;
			}
			a{
				cursor: pointer;
			}
		</style>
	</head>

	<body>
		<div class="fs_main">
			<div style="width: 100%;">
				<div class="floatParent" style="padding:15px">
					<div class="pageTitle">新增发布</div>
					<button style="margin-right: 15px;float: right;" class="btn btn-primary" onclick="paperBack()">返回</button>
				</div>
			</div>
			<div class="sf-mf">
				<div class="form-title floatParent">
					<div class="title-info">基本信息</div>
				</div>
				<form id="form1" class="form-horizontal">
					<div class="form-group">
						<label for="ORDER_NAME" class="col-md-2 control-label"><span class="required">发布标题</span></label>
						<div class="col-sm-5">
							<input type="text" maxlength="200" name="ORDER_NAME" id="ORDER_NAME" class="form-control" />
						</div>
					</div>
					<div class="form-group">
						<label for="SYSTEM_NAME" class="control-label col-sm-2"><span class="required">来源系统</span></label>
						<div class="col-sm-2" id="SystemSelect">
							<input id="SYSTEM_TEXT" type="text" readonly class="form-control search-input" placeholder="请选择">
							<input id="SYSTEM_NAME" name="SYSTEM_NAME" type="hidden">
							<div id="SystemTreeId" style="position:absolute;border:1px solid #3BA4FF;border-radius: 3px;border-top:0px;-moz-border-radius-topleft:0px ;-moz-border-radius-topright: 0px;overflow: auto;display: none;background: #fff;z-index:9999;max-height: 230px;width: 91%;font-size: 10px;"></div>
						</div>
						<label for="ORDER_SOURCE" class="control-label col-md-1 "><span class="required">发布来源</span></label>
						<div class="col-sm-2">
							<select id="ORDER_SOURCE" name="ORDER_SOURCE" class="form-control">
								<option value="变更">变更</option>
								<option value="发布">发布</option>
							</select>
						</div>
					</div>
					<div class="form-group">
						<label for="ORDER_CLASS" class="control-label col-md-2 "><span class="required">发布类型</span></label>
						<div class="col-sm-2">
							<select id="ORDER_CLASS" name="ORDER_CLASS" class="form-control">
								<!--<option value="标准发布">标准发布</option>
								<option value="紧急发布">紧急发布</option>-->
							</select>
						</div>
						<label for="CONNECT_USER" class="control-label col-md-1 "><span class="required">联系人</span></label>
						<div class="col-sm-2">
							<input type="text" maxlength="20" name="CONNECT_USER" id="CONNECT_USER" class="form-control" />
						</div>
					</div>
					<div class="form-group">
						<label for="CONNECT_TEL" class="control-label col-md-2 "><span class="required">联系电话</span></label>
						<div class="col-sm-2">
							<input type="text"  maxlength="11" name="CONNECT_TEL" id="CONNECT_TEL" class="form-control" />
						</div>
						<label for="BEGIN" class="control-label col-md-1"><span class="required">预计开始时间</span></label>
						<div class="col-sm-2">
							<div class="input-group date form_date" id="BEGIN" data-date="" data-date-format="yyyy-mm-dd" data-link-field="dtp_input2" data-link-format="yyyy-mm-dd">
								<input class="form-control" size="16" type="text" id="BEGIN_TIME" readonly>
								<span class="input-group-addon"><span class="glyphicon glyphicon-remove"></span></span>
								<span class="input-group-addon"><span class="glyphicon glyphicon-calendar"></span></span>
							</div>
						</div>
					</div>
					<div class="form-group">
						<label for="EXPET" class="control-label col-md-2 "><span class="required">预计结束时间</span></label>
						<div class="col-sm-2">
							<div class="input-group date form_date" id="EXPET" data-date="" data-date-format="yyyy-mm-dd" data-link-field="dtp_input2" data-link-format="yyyy-mm-dd">
								<input class="form-control" size="16" type="text" id="EXPET_TIME" value="" readonly>
								<span class="input-group-addon"><span class="glyphicon glyphicon-remove"></span></span>
								<span class="input-group-addon"><span class="glyphicon glyphicon-calendar"></span></span>
							</div>
						</div>
					</div>
				</form>
				<div class="form-title floatParent">
					<div class="title-info">发布申请描述</div>
				</div>
				<form id="form2" class="form-horizontal">
					<div class="form-group">
						<label for="ORDER_DSC" class="control-label col-md-2 "><span class="required">发布原因</span></label>
						<div class="col-sm-5">
							<textarea rows="5" maxlength="200" name="ORDER_DSC" id="ORDER_DSC" required class="form-control"></textarea>
						</div>
					</div>
					<div class="form-group">
						<label for="PUBLISH_SCOPE" class="control-label col-md-2 "><span class="required">发布范围</span></label>
						<div class="col-sm-5">
							<textarea rows="5" required maxlength="200" name="PUBLISH_SCOPE" id="PUBLISH_SCOPE" class="form-control"></textarea>
						</div>
					</div>
					<div class="form-group">
						<label for="WORK_HOUR" class="control-label col-md-2 "><span class="required">工作量</span></label>
						<div class="col-sm-5">
							<textarea rows="5" maxlength="200" name="WORK_HOUR" id="WORK_HOUR" class="form-control"></textarea>
						</div>
					</div>
				</form>
				<div class="form-title floatParent">
					<div class="title-info">发布方案</div>
				</div>
				<form id="form3" class="form-horizontal">
					<div class="form-group">
						<label for="TEST_PLAN" class="control-label col-md-2 "><span class="required">测试方案及步骤</span></label>
						<div class="col-sm-5">
							<textarea rows="5" maxlength="400" name="TEST_PLAN" id="TEST_PLAN" class="form-control"></textarea>
						</div>
					</div>
					<div class="form-group">
						<label for="RETREAT_PLAN" class="control-label col-md-2 "><span class="required">回退条件及步骤</span></label>
						<div class="col-sm-5">
							<textarea rows="5" maxlength="400" name="RETREAT_PLAN" id="RETREAT_PLAN" class="form-control"></textarea>
						</div>
					</div>

					<div class="form-group">
						<label for="TEACH_PLAN" class="control-label col-sm-2 "><span class="required">培训计划</span></label>
						<div class="col-sm-5">
							<textarea rows="5" maxlength="400" name="TEACH_PLAN" id="TEACH_PLAN" class="form-control"></textarea>
						</div>
					</div>
					<div class="form-group">
						<label for="RELATE_DEPART" class="control-label col-sm-2 "><span class="required">通知相关部门</span></label>
						<div class="col-sm-5">
							<textarea rows="5" maxlength="400" name="RELATE_DEPART" id="RELATE_DEPART" class="form-control"></textarea>
						</div>
					</div>
				</form>
				<div class="form-title floatParent">
					<div class="title-info">关联工单</div>
					<div style="float: right">
						<button type="button" onclick="connectOrder()">添加关联工单</button>
					</div>
				</div>
				<div style="padding: 10px 25px">
					<table class="table table-bordered">
						<thead>
						<tr><td>ID</td><td>标题</td><td style="width: 40%">内容</td><td>工单类型</td><td>创建时间</td><td>创建人</td><td>操作</td></tr>
						</thead>
						<tbody id="connectBody">
						<tr id="noneInfo"><td colspan="7" style="text-align: center">暂无关联信息</td></tr>
						</tbody>
					</table>
				</div>
				<div style="text-align: center;height: 35px;width: 100%;">
					<button class="btn btn-primary" onclick="save()" type="button" data-loading-text="正在提交...">暂存 </button>
					<button class="btn btn-primary" onclick="add()" type="button" data-loading-text="正在提交...">提交 </button>
					<button style="margin-left: 15px;" class="pageButton btn btn-primary" type="button" onclick="paperBack()">返回</button>
				</div>
			</div>
		</div>
		<script src="../../Lib/jquery-3.4.1.min.js"></script>
		<script src="../../Lib/jsTree/jstree.js"></script>
		<script src="../../Lib/bootstrap-3.3.7-dist/js/bootstrap.js"></script>
		<script src="../../Lib/bootstrap-datapicker/bootstrap-datetimepicker.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../Lib/bootstrap-datapicker/bootstrap-datetimepicker.zh-CN.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../Lib/layer/layer.js"></script>
		<script src="../../Lib/select/js/select-mania.js"></script>
		<script src="../../Lib/easyUpload/easyUploader.js"></script>
		<script src="../../Lib/public.js"></script>
		<script src="../../Lib/all.js" type="text/javascript"></script>
		<script type="text/javascript">
			var typee = "";
			var fileid = "";
			var fag;
			var fag = false;
			var begin_time = ""; //开始时间
			var end_time = ""; //结束时间
			var phone = ""; //联系电话
			var ORDER_NAME = ""; //发布标题
			var CONNECT_USER = ""; //甲方负责人
			var CONNECT_TEL = ""; //联系电话
			var ORDER_DSC = ""; //发布原因
			var PUBLISH_SCOPE = ""; //发布范围
			var WORK_HOUR = ""; //工作量
			var TEST_PLAN = ""; //测试方案及步骤
			var RETREAT_PLAN = ""; //回退条件及步骤
			var TEACH_PLAN = ""; //培训计划
			var RELATE_DEPART = ""; //通知相关部门
			var P_EVENT_ID=$.url("EVENT_ID");
			$(document).ready(function() {
				$('#ORDER_SOURCE').selectMania({
					themes: ['green'],
					placeholder: '请选择发布来源',
					removable: true,
					ajax: false,
				});
				$('#ORDER_CLASS').selectMania({
					themes: ['green'],
					placeholder: '请选择发布类型',
					removable: true,
					ajax: false,
				});
				$('#BEGIN').datetimepicker({
					language: 'zh-CN',
					weekStart: 1,
					todayBtn: 1,
					autoclose: 1,
					todayHighlight: 1,
					startView: 2,
					minView: 2,
					forceParse: 0
				});
				$('#EXPET').datetimepicker({
					language: 'zh-CN',
					weekStart: 1,
					todayBtn: 1,
					autoclose: 1,
					todayHighlight: 1,
					startView: 2,
					minView: 2,
					forceParse: 0
				});
				getSystemTree();
				getSelectjquery({
					"P_EVENT_ID": P_EVENT_ID,
				}, 'ORDER_CLASS', '/order/OrderTypeCombo');
				$("#CONNECT_TEL").blur(function() {
					checkTel();
				})
			});
			function getSelectjquery(data, useId, url) {
				webapi(url, data, function(res) {
					var str = "";
					if(res.length > 0) {
						$.each(res, function(i, item) {
							str += "<option  value=" + item.ID + ">" + item.TEXT + "</option>";
						});
						$("#" + useId).append(str);
						$('#' + useId).selectMania('update');
					}
				}, function(err) {
					layer.alert("获取下拉数据错误,错误信息为" + err);
				});

			}
//加载部门树
			function getSystemTree() {
				$departTree = $('#SystemTreeId').jstree({
					'core': {
						"multiple": false,
						'data': {
							"url": urlpath + "/order/GetProsysTree",
							"data": function(node) {
								node.id=="#"? "0":node.id;
								return {
									"P_PROSYS_ID":node.id,
								};
							}
						}
					},
					"plugins": ["search"],
					"search": {
						"show_only_matches": true,
						"show_only_matches_children": true
					}
				});
				$departTree.bind('activate_node.jstree', function(obj, e) {
					$("#SYSTEM_NAME").val(e.node.id);
					$("#SYSTEM_TEXT").val(e.node.text);
				})
				$("#SystemSelect").on("blur", "#SYSTEM_TEXT", function(e) {
					setTimeout(function() {
						$("#SystemTreeId").hide();
					}, 200)
				})
				$("#SystemSelect").on("click", "#SYSTEM_TEXT", function() {
					if($("#SystemTreeId")[0].style.display == "none" ||
						$("#SystemTreeId")[0].style.display == "") {
						$("#SystemTreeId")[0].style.display = "block";
					} else if($("#SystemTreeId")[0].style.display == "block") {
						$("#SystemTreeId")[0].style.display = "none";
					}
				});
			}
			function checkTel() {
				var obj = document.getElementById("CONNECT_TEL");
				var value = obj.value;
				var regTel1 = /^(([0\+]\d{2,3}-)?(0\d{2,3})-)(\d{7,8})(-(\d{3,}))?$/.test(value); //带区号的固定电话
				var reg = /^1[3|4|5|7|8][0-9]{9}$/.test(value);
				if(value != "") {
					if(!regTel1 && !reg) {
						layer.alert("电话号码输入有误！");
						fas = false;
						return false;
					}
				}
				fas = true;
				return true;
			}
			function add() {
				begin_time = $("#BEGIN").val(); //开始时间
				end_time = $("#EXPET").val(); //结束时间
				phone = $("#CONNECT_TEL").val(); //联系电话
				ORDER_NAME = $("#ORDER_NAME").val(); //发布标题
				CONNECT_USER = $("#ORDER_SOURCE").val(); //甲方负责人
				CONNECT_TEL = $("#CONNECT_TEL").val(); //联系电话
				ORDER_DSC = $("#ORDER_DSC").val(); //发布原因
				PUBLISH_SCOPE = $("#PUBLISH_SCOPE").val(); //发布范围
				WORK_HOUR = $("#WORK_HOUR").val(); //工作量
				TEST_PLAN = $("#TEST_PLAN").val(); //测试方案及步骤
				RETREAT_PLAN = $("#RETREAT_PLAN").val(); //回退条件及步骤
				TEACH_PLAN = $("#TEACH_PLAN").val(); //培训计划
				RELATE_DEPART = $("#RELATE_DEPART").val(); //通知相关部门
				var connect_ids = getConnectIds();
				if(validateForm()) {
					var keyvalue = {
						"P_EVENT_ID": 1011, //--表单流程事件ID
						"P_SYS_USER_ID": "", //指定工单处理人，没有传空值
						"P_OPER_ID": "1000", //操作工号
						"P_FUJIAN_STR": fileid, //处理时上传的附件，附件信息拼接字符
						"ORDER_NAME": ORDER_NAME,
						"SYSTEM_NAME":$("#SYSTEM_TEXT").val(),
						"SYSTEM_ID": $("#SYSTEM_NAME").val(),
						"ORDER_SOURCE": $("#ORDER_SOURCE").selectMania('get')[0].text,
						"ORDER_CLASS": $("#ORDER_CLASS").selectMania('get')[0].text,
						"CONNECT_USER": CONNECT_USER,
						"CONNECT_TEL": CONNECT_TEL,
						"ORDER_DSC": ORDER_DSC,
						"PUBLISH_SCOPE": PUBLISH_SCOPE,
						"WORK_HOUR": WORK_HOUR,
						"TEST_PLAN": TEST_PLAN,
						"RETREAT_PLAN": RETREAT_PLAN,
						"TEACH_PLAN": TEACH_PLAN,
						"RELATE_DEPART": RELATE_DEPART,
						"BEGIN_TIME": $("#BEGIN_TIME").val(),
						"BEGIN_TIME": $("#EXPET_TIME").val(),
						"P_RESEND_ID":"",
						"P_CONNECT_ID":connect_ids
					}
					orderAdd(keyvalue);
				}
			}

			function save() {
				var connect_ids = getConnectIds();
				phone = $("#CONNECT_TEL").val(); //联系电话
				ORDER_NAME = $("#ORDER_NAME").val(); //发布标题
				CONNECT_USER = $("#ORDER_SOURCE").val(); //甲方负责人
				CONNECT_TEL = $("#CONNECT_TEL").val(); //联系电话
				ORDER_DSC = $("#ORDER_DSC").val(); //发布原因
				PUBLISH_SCOPE = $("#PUBLISH_SCOPE").val(); //发布范围
				WORK_HOUR = $("#WORK_HOUR").val(); //工作量
				TEST_PLAN = $("#TEST_PLAN").val(); //测试方案及步骤
				RETREAT_PLAN = $("#RETREAT_PLAN").val(); //回退条件及步骤
				TEACH_PLAN = $("#TEACH_PLAN").val(); //培训计划
				RELATE_DEPART = $("#RELATE_DEPART").val(); //通知相关部门

				if(validateForm()) {
					var keyvalue = {
						"P_EVENT_ID": 1011, //--表单流程事件ID
						"P_SYS_USER_ID": "", //指定工单处理人，没有传空值
						"P_OPER_ID": "1001", //操作工号
						"P_FUJIAN_STR": fileid, //处理时上传的附件，附件信息拼接字符
						"ORDER_NAME": ORDER_NAME,
						"SYSTEM_NAME":$("#SYSTEM_TEXT").val(),
						"SYSTEM_ID": $("#SYSTEM_NAME").val(),
						"ORDER_SOURCE": $("#ORDER_SOURCE").selectMania('get')[0].text,
						"ORDER_CLASS": $("#ORDER_CLASS").selectMania('get')[0].text,
						"CONNECT_USER": CONNECT_USER,
						"CONNECT_TEL": CONNECT_TEL,
						"ORDER_DSC": ORDER_DSC,
						"PUBLISH_SCOPE": PUBLISH_SCOPE,
						"WORK_HOUR": WORK_HOUR,
						"TEST_PLAN": TEST_PLAN,
						"RETREAT_PLAN": RETREAT_PLAN,
						"TEACH_PLAN": TEACH_PLAN,
						"RELATE_DEPART": RELATE_DEPART,
						"BEGIN_TIME": $("#BEGIN_TIME").val(),
						"BEGIN_TIME": $("#EXPET_TIME").val(),
						"P_RESEND_ID":"",
						"P_CONNECT_ID":connect_ids
					}
					orderSave(keyvalue);
				}
			}

			function validateForm() {
				fag = false;
				begin_time = $("#BEGIN_TIME").val(); //开始时间
				end_time = $("#EXPET_TIME").val(); //结束时间
				phone = $("#CONNECT_TEL").val(); //联系电话
				ORDER_NAME = $("#ORDER_NAME").val(); //发布标题
				CONNECT_USER = $("#ORDER_SOURCE").val(); //甲方负责人
				CONNECT_TEL = $("#CONNECT_TEL").val(); //联系电话
				ORDER_DSC = $("#ORDER_DSC").val(); //发布原因
				PUBLISH_SCOPE = $("#PUBLISH_SCOPE").val(); //发布范围
				WORK_HOUR = $("#WORK_HOUR").val(); //工作量
				TEST_PLAN = $("#TEST_PLAN").val(); //测试方案及步骤
				RETREAT_PLAN = $("#RETREAT_PLAN").val(); //回退条件及步骤
				TEACH_PLAN = $("#TEACH_PLAN").val(); //培训计划
				RELATE_DEPART = $("#RELATE_DEPART").val(); //通知相关部门
				var pat = /^1\d{10}$/;
				if(trim(ORDER_NAME) == "") {
					poptext("请输入发布标题");
					return fag;
				} else if(trim($("#SYSTEM_NAME").val()) == "") {
					poptext("请选择来源系统");
					return fag;
				} else if(trim($("#ORDER_SOURCE").selectMania('get')[0].value) == "") {
					poptext("请选择发布来源");
					return fag;
				} else if(trim($("#ORDER_CLASS").selectMania('get')[0].value) == "") {
					poptext("请选择发布类型");
					return fag;
				} else if(begin_time == "") {
					poptext("请选择预计开始时间");
					return fag;
				} else if(end_time == "") {
					poptext("请选择预计结束时间");
					return fag;
				} else if(!pat.test(phone)) {
					poptext("请输入正确的联系方式");
					return fag;
				} else if(trim(CONNECT_USER) == "") {
					poptext("请输入甲方负责人");
					return fag;
				} else if(trim(CONNECT_TEL) == "") {
					poptext("请输入联系电话");
					return fag;
				} else if(trim(ORDER_DSC) == "") {
					poptext("请输入发布原因");
					return fag;
				} else if(trim(PUBLISH_SCOPE) == "") {
					poptext("请输入发布范围");
					return fag;
				} else if(trim(WORK_HOUR) == "") {
					poptext("请输入工作量");
					return fag;
				} else if(trim(TEST_PLAN) == "") {
					poptext("请输入测试方案及步骤");
					return fag;
				} else if(trim(RETREAT_PLAN) == "") {
					poptext("请输入回退条件及步骤");
					return fag;
				} else if(trim(TEACH_PLAN) == "") {
					poptext("请输入培训计划");
					return fag;
				} else if(trim(RELATE_DEPART) == "") {
					poptext("请输入通知相关部门");
					return fag;
				} else {
					fag = true;
					return fag;
				}
				return fag;
			}

			function processVal(val) {
				if(val != "") {
					if(val.indexOf(',') > -1 || val.indexOf(';') > -1) {
						val.replace(',', '，');
						val.replace(';', '；');
					} else {
						return val;
					}

				} else {
					return val;
				}
			}

			function poptext(text) {
				layer.alert(text);
			}

			function addInfo() {
				var data = "";
				var arr = $("#mainForm").serializeArray();
				for(var i = 0; i < arr.length; i++) {
					var val = arr[i].value;
					val = processVal(val);
					data += arr[i].name + "," + val + ";";
				}
				data = data.substring(0, data.length - 1);
				layer.load(indexLoading);
				orderAdd("1011", data, "", "", "1000")
			}
		</script>
	</body>

</html>